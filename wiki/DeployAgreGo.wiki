#summary HOWTO deploy AgreGo
#labels Phase-Deploy,Featured

==pre requisite / architecture explanation==

TODO: Describe the network achitecture and what is needed (lartc)

You will certainly have more than one interface, on your Agrego endpoints. To
configure your interfaces you can follow this HOWTO (on linux) http://lartc.org/lartc.html
especially the part _4.2. Routing for multiple uplinks/providers_ : http://lartc.org/lartc.html#LARTC.RPDB.MULTIPLE-LINK.

If you have one or several (one per connection) NATed router between your distant and your local endpoint, you have to configure it to forward UDP packets on ports used by Agrego (you can configure these ports). 

==Install from source/package==

From package:
 * agrego-local
 * agrego-distant

aptitude install

Agrego use autotools so you can checkout from svn or use the dist tarball install agrego using:
{{{
./configure
make 
make install
}}}


There is only one tarball because it contains local and distant, contrary to the .deb packages.

==Package content==

Packages agrego-local and agrego-distant contains same files.
Here we will describe the agrego-distant package.
Replace distant by local to see the content of the agrego-local package.

2 binaries:
 * agrego_manage-distant.sh : this script allow to add and remove agrego instance below
 * agrego-distant   : the agrego daemon which will do the work

==Agrego instance==

As there is a need to launch several instance of Agrego daemon on the same machine, Agrego installation has been designed in this way.
When Agrego is installed by using package, a first instance is created. So if you don't need several Agrego instance, you will not need to manage them.

Create or remove Agrego instance can be done with agrego_manage-distant.sh script:
{{{
$ agrego_manage-distant.sh add agrego_1
$ agrego_manage-distant.sh list
agrego_1
$ agrego_manage-distant.sh del agrego_1
}}}

This script will create for you a directory in /etc/agrego-distant or /etc/agrego-local and fill it with 3 files:
 * start.sh
 * stop.sh
 * agrego.ini

The default version of these files are stored on /usr/share/agrego-distant (or local).

How the init.d script will works with several agrego instance (replace distant by local):
{{{
  # start all agrego instance
$ /etc/init.d/agrego-distant start

  # get the status of several instances 
$ /etc/init.d/agrego-distant stop my_instance1 my_instance2

  # stop one agrego instance
$ /etc/init.d/agrego-distant stop my_instance
}}}

==Configure Agrego==

Agrego configuration file is agrego.ini file. The default version is commented. This file is designed to be the same on both endpoints (local and distant) specifically for the interfaces and the Link`_`? sections.

It contains at least 5 sections:
 * Network
 * Interfaces
 * Link`_`1
 * Failure detection
 * Connection rehabilitation
 * Logs

The section Link`_`1 will be declined as Link`_`2, Link`_`3... according the number of network link you will aggregate.

In this file terms local and distant represents the endpoints, as in the package name (agrego-distant, agrego-local).

Usually you will not need to change values of Failure detection, Connection rehabilitation and Logs sections.

The value of Network.private_key need to be the same for distant and local server, this allow the distant to connect to the local endpoint.

The Interfaces section contain the configuration of the IP tunnel.
If you use several instance of Agrego daemon, be careful that all IP tunnels have differents IP address. In this case the best thing is to put each IP tunnel in an other subnet.

Interfaces.number_of_interfaces is the number of interface to agregate.
This define the number of sections Link`_`? the file will contains.
For example if Interfaces.number_of_interfaces = 2, the file must also contains the 2 sections Link_1 and Link_2.

Link`_`? sections contains the description of a connection to agregate.
Basicaly it's local IP address and port and distant IP address and port.
The coefficient allow to control the speed of this connection compared with other connection.

_start.sh_ and _stop.sh_ files are shell scripts which are runned respectively when the Agrego daemon (which correspond to these files) start and stop. They are also runned when the daemon is restarted.

The usual use of these script is to add NAT, and change default route to the agrego TUN interface and to put back default route and NAT when agrego stop.

==Troubleshooting during installation==

If you want to use _netcat_ to check that distant endpoint can connect to local endpoint using UDP, you will see an error like "_network unreachable_".
This error doesn't mean that the distant can't discuss with the local with the UDP protocol. TCP works fine but remember Agrego use UDP.